{% extends 'main/loggedIn.html' %}

{% block head %} 
<link rel="stylesheet" href="{{url_for('static',filename='css/profile.css')}}"> 

<link rel="stylesheet" href="../../static/css/font-awesome-4.7.0/css/font-awesome.min.css">

<script src ="../../static/js/functions.js"> </script>

{% endblock %} 

{% block content %}

<!-- was class not id -->
<div id = "profile-container"> 

	<div id = "navigator"> 
		<ul>
			<li class="panel-toggle"> <a href="#" onclick="togglePanel(0);"> About </a>  </li> 
			<li class="panel-toggle"> <a href="#" onclick="togglePanel(1);">Photos  </a> </li>
			<li class="panel-toggle"> <a href="#" onclick="togglePanel(2);">Schedule </a> </li> 
			<li class="panel-toggle"> <a href="#" onclick="togglePanel(3);">Reviews </a> </li>
		</ul> 

	</div> 

	<div class = "section-content">
		<div class = "container" id = "container-profile"> 
			<div class = "panel" id = "about"> 
				<button  id=toggleNav onclick="toggleDiv('navigator');event.preventDefault()"> Hide </button>
				<p id = "p-name"> Username: {{user['username']}} </p> <br/> 
				<p id = "p-email"> E-mail: {{user['email']}} </p> <br/>
				<p id = "p-country"> Country: {{user['country']}} </p> <br/>
				<p id = "p-reg-date"> Member Since: {{user['reg_date']}} </p> <br/> 
				<p id = "p-last-login"> Last Login: {{user['last_login']}} </p> <br/> 
				<p id ="p-panel"> About: <p id ="p-bio"> {{user['bio']}} </p> </p> <br/>  
			</div>


			<div class = "panel" id = "photos"> 
				<div id = "load-photos">
					ding
				</div>

				
				<div id = "submit-photos">
					<form id="photos-form" >
						<button id="photos-submit-button" onclick="activatePhotosInput()"> 
							<input id="photos-input" type="file" name="file" hidden>	
						</button>	
					</form>
				</div>



			</div> 

			<div class = "panel" id = "schedule"> 
				schedule	
			</div> 

			<div class = "panel" id = "reviews"> 

				<div id = "reviews-submit"> 
					<div class ="reviews-star"> 
						<span id="star1" class="click fa fa-star fa-3x"></span>
						<span id="star2" class="click fa fa-star fa-3x"></span>
						<span id="star3" class="click fa fa-star fa-3x"></span>
						<span id="star4" class="click fa fa-star fa-3x"></span>
						<span id="star5" class="click fa fa-star fa-3x"></span>

						<form id = "reviews-rating-form">
							<input id="reviews-rating" type="number" name="num-stars" min="1" max="5" hidden> 
						</form>
					</div> 

					<div id ="reviews-box"> 
						<textarea placeholder="review title" id="reviews-title"></textarea>
						<textarea placeholder="review body" id="reviews-input"></textarea>
					</div> 

					<div id ="container-reviews-button">
						<button id= "reviews-button" > Submit Review </button> 
					</div> 
				</div> 

				<div id = "reviews-load">

					<ul id = "reviews-list">
						
					</ul>

				</div>
			
			</div> 


		</div> 

		{% if myProfile %} 

		<div id ="edit-bar"> 
			<button id="button-edit-toggle"> Edit </button> 
			<button id="button-save" onclick="updateProfile()"> Save </button>
			<button id="button-cancel"> Cancel </button>
		</div>
		{% endif %}

	</div> 

</div>

<script>

try {
	document.getElementById("button-edit-toggle").addEventListener("click", toggle);
}
catch (error) {
	if (error instanceof TypeError) {
		console.error("No edit button -- viewing other user profile");
	}
}

var stars = document.querySelectorAll('.fa-star');
console.log(stars);


var stars = document.querySelectorAll('.fa-star'); 
const reviewRating = document.getElementById("reviews-rating");

function setRating(i) { 
	console.log("rating: " + i);
	reviewRating.value = i; 
} 


function clickStar() {
	stars.forEach ( function(star) {
		star.style.color='black';
	});
	console.log('click');
	this.style.color = 'yellow';
	if (this.previousElementSibling == null) { 
		return setRating(1); 
	}
	return setRating(1 + clickStarHelper(this.previousElementSibling));
}


function clickStarHelper(node) {
	node.style.color = 'yellow';
	var leftSib = node.previousElementSibling;
	if (leftSib == null) {
		return 1;
	}
	return 1 + clickStarHelper(node.previousElementSibling);
}


stars.forEach( function(star) {
	star.addEventListener ('click', clickStar); 
});


function countStars () {
	let rating = 0;
	for (let i = 0; i < stars.length; i++) {
		const star = stars[i];
		if (star.style.color == 'yellow') {
			rating++;
		}
	}
	console.log(rating);
	return rating;
}


const reviewButton = document.getElementById("reviews-button");
const reviewForm = document.getElementById("reviews-rating-form");


reviewButton.addEventListener('click', function() {

	const formData = new FormData(reviewForm);
	const reviewText = document.getElementById("reviews-input").value;
	const reviewTitle = document.getElementById("reviews-title").value;

	formData.append('review-body',reviewText);
	formData.append('review-title',reviewTitle);
	console.log(formData);
	console.log(reviewText);
	console.log("reviewButton eventlistener");


	fetch('/postReview', {
		method: 'POST',
		body: formData
	})
	.then (response =>  {
		if (!response.ok) {
			throw new Error ('Network response not OK');
		}
	})
	.then (data => { console.log(data);})
	.catch (error => console.error('There was a problem with fetch', error));
});

	


const photoForm = document.getElementById("photos-form");

// when submit action gets triggered by next event listener, send data to routing
photoForm.addEventListener('submit', function(event) {
	event.preventDefault(); 

	const formData = new FormData(photoForm);

	fetch('/photo-upload', {
		method: 'POST',
		body: formData,
	}).then( function (response) {
		console.log(response);
	});

});


const photosInput = document.getElementById("photos-input");
const photosButton = document.getElementById("photos-submit-button");

// clicking the button will click the input tag
function activatePhotosInput() {
	document.getElementById("photos-input").click();
	console.log("activatePhotosInput()");
}


// as soon as photo is uploaded, submit action is triggered
photosInput.addEventListener("change", function() {
	photoForm.submit();
});


// for saving changes made to profile
function toggle() {

	// replace bio with the input element
	let bio = document.getElementById("p-bio");
	let bodyText = bio.textContent; 
	var input = document.createElement("input");
	input.type = "text";
	input.value= bodyText;
	input.id = 'p-input'
	bio.replaceWith(input); 

	// make 2 other buttons disappear
	let saveButton = document.getElementById("button-save"); 
	let cancelButton = document.getElementById("button-cancel"); 
	saveButton.style.display ='block';
	cancelButton.style.display = 'block'
	saveButton.innerText = 'Modified Save'; 
	saveButton.onclick = function () {
		updateProfile();
		var newBio = document.createElement('p');
		newBio.id ='p-bio';
		newBio.innerText = input.value;
		input.replaceWith(newBio);
		saveButton.style.display = 'none';
		cancelButton.style.diplay = 'none'; 

	}

	cancelButton.onclick = function () {
		var newBio = document.createElement('p');
		newBio.id ='p-bio';
		newBio.innerText = input.value;
		input.replaceWith(newBio);
		saveButton.style.display = 'none';
		cancelButton.style.diplay = 'none'; 
	}
	console.log("hello 2")

}




try {
	document.getElementById("button-cancel").addEventListener("click", myFunction2);
}
catch (error) {
	console.error ("No cancel button; viewing other user's profile");
}

function myFunction2() {
	console.log('myFunction2')
}



async function getReviews() {

	try {

		// getting ID of profile currently being viewe
		const profileViewResponse = await fetch ('/getViewedProfile'); 
		const profileViewID = await profileViewResponse.text();
		console.log("getReviews") 
		console.log(profileViewID);
		console.log("getReviews - END"); 

		// passing ID to the DB route
		const reviewsResponse = await fetch(`/getReviews?userID=${profileViewID}`)
		const reviewsText = await reviewsResponse.text();

		console.log(reviewsResponse);
		console.log(reviewsText);
		const review = await parseReview(reviewsText);

	}

	catch (error) {
		console.error ('Errors: ', error);
	}

}


async function parseReview(_reviews) {
	let reviews = JSON.parse(_reviews);
	console.log();
	console.log("parseReview()")
	console.log("Reviews: ", reviews);
	console.log();
	const _id = reviews._id;
	console.log (_id);
	console.log();
	console.log('Printing Reviews: ');
	reviews.forEach( review => populateReviews(review));
	console.log('Reviews done printing');
} 


document.addEventListener('DOMContentLoaded',getReviews);


</script> 

{% endblock %}


